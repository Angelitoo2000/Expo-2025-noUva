<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - noUva</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900 font-sans">

  <!-- Navbar -->
  <nav class="bg-[#00224F] text-white p-4">
    <div class="container mx-auto flex items-center justify-between">
      <img src="{{ url_for('static', filename='home/logoFondoAzul.jpeg') }}" 
           alt="Logo" class="h-16 w-40">
      <div class="flex items-center space-x-6">
        <a href="{{ url_for('home_page') }}" class="hover:underline">Home</a>
        <a href="{{ url_for('universities_page') }}" class="hover:underline">Universities</a>
        <a href="{{ url_for('podcasts_page') }}" class="hover:underline">Podcasts</a>
        <a href="{{ url_for('challenges_page') }}" class="hover:underline">Challenges</a>
        <a href="{{ url_for('subcription_page') }}" class="hover:underline">Get premium</a>
        <a href="{{ url_for('perfil_page') }}">
          <img id="navbar-pic"
               src="{{ url_for('static', filename='default.png') }}"
               alt="Profile"
               class="h-10 w-10 rounded-full border-2 border-white hover:scale-105 transition-transform duration-200">
        </a>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <main class="max-w-4xl mx-auto py-10 px-6">

    <div class="mb-10 text-center">
      <h1 id="profile-name" class="text-4xl font-bold mb-2">Loading...</h1>
      <p class="text-lg text-gray-600">Update your profile and preferences.</p>
    </div>

    <section class="bg-gray-50 rounded-2xl shadow-lg p-8 mb-8">
      <div class="flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8">
        <div class="relative w-40 h-40">
          <img id="profile-pic" class="w-full h-full object-cover rounded-full border-4 border-white shadow-md"
               src="{{ url_for('static', filename='default.png') }}" alt="Profile picture">
          <label for="file-upload" class="absolute bottom-0 right-0 p-2 bg-[#00224F] rounded-full text-white cursor-pointer hover:bg-[#001633] transition-colors" title="Change profile picture">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.86-1.542A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.86 1.542A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2v-9z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
          </label>
          <input id="file-upload" type="file" class="hidden" accept="image/*" />
        </div>
        <div class="flex flex-col space-y-4 w-full">
          <button id="btn-remove-pic" class="w-full md:w-auto px-6 py-2 rounded-xl text-white font-semibold bg-[#00224F] hover:bg-[#001633] transition-colors shadow-md">
            Remove profile picture
          </button>
        </div>
      </div>
    </section>

    <section class="bg-gray-50 rounded-2xl shadow-lg p-8">
      <h2 class="text-2xl font-semibold mb-6">Personal information</h2>
      <form id="profile-form" class="space-y-6">
        <div>
          <label for="input-name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="input-name" name="nombre" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-[#00224F] focus:ring-[#00224F] focus:outline-none" placeholder="Your name" required>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="px-6 py-2 rounded-xl text-white font-semibold bg-[#00224F] hover:bg-[#001633] transition-colors shadow-md">
            Save changes
          </button>
        </div>
      </form>
      <div id="message-box" class="fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg text-white font-medium z-50 transition-opacity duration-300 opacity-0"></div>
    </section>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
      const profilePic = document.getElementById("profile-pic");
      const profileName = document.getElementById("profile-name");
      const inputName = document.getElementById("input-name");
      const profileForm = document.getElementById("profile-form");
      const btnRemovePic = document.getElementById("btn-remove-pic");
      const fileUpload = document.getElementById("file-upload");
      const messageBox = document.getElementById("message-box");

      // Diccionario para traducir mensajes del backend
      const translations = {
        "Cambio de foto exitoso": "Profile picture updated successfully.",
        "Foto de perfil eliminada": "Profile picture removed.",
        "Nombre actualizado": "Profile updated successfully.",
        "Error al subir la imagen.": "Error uploading picture.",
        "Error al guardar el nombre.": "Error saving name.",
        "Error al eliminar la imagen.": "Error deleting picture."
      };

      function translateMessage(msg) {
        return translations[msg] || msg; // si existe traducciÃ³n la usa, sino deja el original
      }

      function showMessage(message, isError = false) {
          messageBox.textContent = message;
          messageBox.className = `fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg text-white font-medium z-50 transition-opacity duration-300 opacity-100 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
          setTimeout(() => {
              messageBox.className = `fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg text-white font-medium z-50 transition-opacity duration-300 opacity-0`;
          }, 5000);
      }

      // Load profile data
      try {
          const res = await fetch("http://127.0.0.1:5000/profile", { credentials: "include" });
          const data = await res.json();
          if (!data.error) {
              profileName.innerText = data.nombre;
              inputName.value = data.nombre;
              if (data.foto_url) {
                  profilePic.src = "/static/" + data.foto_url;
                  document.getElementById("navbar-pic").src = "/static/" + data.foto_url;
              }
          }
      } catch (err) {
          console.error("Error loading profile:", err);
      }

      // Upload new picture
      fileUpload.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          try {
              const res = await fetch("http://127.0.0.1:5000/profile/picture", {
                  method: "POST",
                  credentials: "include",
                  body: formData
              });
              const msg = await res.json();
              if (msg.error) {
                  showMessage(translateMessage(msg.error), true);
              } else {
                  showMessage(translateMessage(msg.message) || "Profile picture updated successfully.");
                  profilePic.src = msg.foto_url;
                  document.getElementById("navbar-pic").src = msg.foto_url;
              }
          } catch (err) {
              console.error("Error uploading picture:", err);
              showMessage("Error uploading picture.", true);
          }
      });

      // Save name
      profileForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const updated = { nombre: inputName.value };

          try {
              const res = await fetch("http://127.0.0.1:5000/profile", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify(updated)
              });
              const msg = await res.json();
              if (msg.error) {
                  showMessage(translateMessage(msg.error), true);
              } else {
                  showMessage(translateMessage(msg.message) || "Profile updated successfully.");
                  profileName.innerText = updated.nombre;
              }
          } catch (err) {
              console.error("Error saving name:", err);
              showMessage("Error saving name.", true);
          }
      });

      // Remove profile picture
      btnRemovePic.addEventListener("click", async () => {
          try {
              const res = await fetch("http://127.0.0.1:5000/profile/picture", {
                  method: "DELETE",
                  credentials: "include"
              });
              const msg = await res.json();
              if (msg.error) {
                  showMessage(translateMessage(msg.error), true);
              } else {
                  showMessage(translateMessage(msg.message) || "Profile picture removed.");
                  profilePic.src = msg.foto_url;
                  document.getElementById("navbar-pic").src = msg.foto_url;
              }
          } catch (err) {
              console.error("Error deleting picture:", err);
              showMessage("Error deleting picture.", true);
          }
      });
  });
  </script>

  <!-- Footer -->
  <footer class="bg-[#00224F] text-white text-center py-6 mt-10">
    <p class="text-sm">&copy; 2025 NoUva. All rights reserved.</p>
  </footer>
  
</body>
</html>
